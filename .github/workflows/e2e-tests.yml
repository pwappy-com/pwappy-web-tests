# ワークフローの名称
name: Multi-OS E2E Tests

# ワークフローが実行されるトリガーを定義
on:
  # 定期実行 (schedule)
  schedule:
    # UTCの3時間毎に実行。JST 10時, 13時, 16時, 19時, 22時, 翌5時, 8時に実行 (Normalテスト用)
    - cron: '0 1,4,7,10,13,20,23 * * *'
    # UTCの毎日0時0分 (JST 9時) に実行 (Premiumテスト用) GeminiAPIキーの有料化に伴い一時停止
    - cron: '0 0 * * *'
  # 手動実行 (workflow_dispatch)
  workflow_dispatch:
    inputs:
      # 手動実行時に実行するテストスイートを選択するドロップダウン
      test_suite:
        description: '実行するテストスイートを選択'
        required: true
        default: 'normal'
        type: choice
        options:
          - normal
          - premium
          - all
      # 手動実行時に実行するOSを選択するドロップダウン
      os:
        description: '実行するOSを選択'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu-latest
          - windows-latest
          - macos-latest

# ワークフローを構成するジョブを定義
jobs:
  # ===================================================================
  # ジョブ 1: 実行するテストのマトリックスとフラグを動的に準備する
  # ===================================================================
  prepare-matrix:
    runs-on: ubuntu-latest
    # このジョブの出力を定義。後続のジョブの条件分岐やマトリックスとして使用。
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      run_normal: ${{ steps.get_suite.outputs.run_normal }}
      run_premium: ${{ steps.get_suite.outputs.run_premium }}
    steps:
      - name: Determine test matrix
        id: set-matrix
        run: |
          # 全OS実行か個別OS実行かに基づいてマトリックスJSONを生成
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event.inputs.os }}" == "all" ]]; then
            echo 'matrix=[{"os": "ubuntu-latest", "browser": "chromium"}, {"os": "windows-latest", "browser": "chromium"}, {"os": "macos-latest", "browser": "webkit"}]' >> $GITHUB_OUTPUT
          else
            # 手動実行で特定のOSが選択された場合は、そのOSに対応する組み合わせのみを生成する
            case "${{ github.event.inputs.os }}" in
              "ubuntu-latest")
                echo 'matrix=[{"os": "ubuntu-latest", "browser": "chromium"}]' >> $GITHUB_OUTPUT
                ;;
              "windows-latest")
                echo 'matrix=[{"os": "windows-latest", "browser": "chromium"}]' >> $GITHUB_OUTPUT
                ;;
              "macos-latest")
                echo 'matrix=[{"os": "macos-latest", "browser": "webkit"}]' >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Determine Test Suite Flags
        id: get_suite
        shell: bash
        run: |
          # 実行すべきスイート（Normal/Premium）をフラグとして出力
          if [ "${{ github.event_name }}" == "schedule" ]; then
            if [ "${{ github.event.schedule }}" == "0 0 * * *" ]; then
              echo "run_premium=true" >> $GITHUB_OUTPUT
            else
              echo "run_normal=true" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SUITE="${{ github.event.inputs.test_suite }}"
            if [ "$SUITE" == "normal" ] || [ "$SUITE" == "all" ]; then echo "run_normal=true" >> $GITHUB_OUTPUT; fi
            if [ "$SUITE" == "premium" ] || [ "$SUITE" == "all" ]; then echo "run_premium=true" >> $GITHUB_OUTPUT; fi
          fi

  # ===================================================================
  # ジョブ 2: Normalテストの実行
  # ===================================================================
  e2e-normal:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.run_normal == 'true' }}
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      # 同時に実行するOS(3でubuntu,window,macを並列実行)
      max-parallel: 3
      matrix:
        include: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    env:
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # キャッシュキー接頭辞の設定
      - name: Set cache key prefix
        run: |
          echo "CACHE_KEY_PREFIX=${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      # Ubuntuランナーには日本語フォントがないためインストール (文字化け/トーフ対策)
      - name: Install Japanese fonts (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      # 日本時間（JST）で日付を取得するように修正
      - name: Get daily cache key suffix
        id: get-date
        run: echo "date=$(TZ=Asia/Tokyo date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Playwright browsers
        id: cache-playwright-browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-

      - name: Install Playwright Browsers
        if: steps.cache-playwright-browsers.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Set OS Short Name
        shell: bash
        run: |
          OS_NAME="${{ matrix.os }}"
          if [[ "$OS_NAME" == "ubuntu-latest" ]];then echo "OS_SHORT_NAME=ubuntu" >> $GITHUB_ENV;
          elif [[ "$OS_NAME" == "windows-latest" ]]; then echo "OS_SHORT_NAME=win" >> $GITHUB_ENV;
          elif [[ "$OS_NAME" == "macos-latest" ]]; then echo "OS_SHORT_NAME=macos" >> $GITHUB_ENV;
          else echo "OS_SHORT_NAME=unknown" >> $GITHUB_ENV; fi

      - name: Run Normal E2E Tests
        id: run_tests
        shell: bash
        run: |
          npx playwright test tests/specs/normal --project=${{ matrix.browser }} --reporter=line --workers=1
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT
        env:
          TEST_RUN_SUFFIX: ${{ env.OS_SHORT_NAME }} 
          PWAPPY_TEST_BASE_URL: ${{ secrets.PWAPPY_TEST_BASE_URL }}
          PWAPPY_TEST_AUTH: ${{ secrets.PWAPPY_TEST_AUTH }}
          PWAPPY_TEST_IDENT_KEY: ${{ secrets.PWAPPY_TEST_IDENT_KEY }}
          PWAPPY_LOGIN: "1"
          TEST_GEMINI_API_KEY: ${{ secrets.TEST_GEMINI_API_KEY }}

      # テスト失敗時：このブラウザ/OSに関連する「全ての古いキャッシュ」を削除する
      - name: Delete cache on failure
        if: failure()
        run: |
          echo "Test failed. Clearing all related caches for ${{ env.CACHE_KEY_PREFIX }}..."
          # 一致する接頭辞を持つキャッシュをリストアップして全て削除
          gh cache list --key "${{ env.CACHE_KEY_PREFIX }}-" --json key --jq '.[].key' | xargs -I {} gh cache delete {} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-normal-${{ matrix.os }}-${{ matrix.browser }}-${{ github.run_id }}
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Mark Job Failure
        if: steps.run_tests.outputs.EXIT_CODE != '0'
        run: exit 1

  # ===================================================================
  # ジョブ 3: Premiumテストの実行
  # ===================================================================
  e2e-premium:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.run_premium == 'true' }}
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      # ポイント消費の重複や競合を防ぐため、OS間でも1つずつ順番に実行する。
      max-parallel: 1
      matrix:
        include: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    env:
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set cache key prefix
        run: |
          echo "CACHE_KEY_PREFIX=${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Japanese fonts (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Get daily cache key suffix
        id: get-date
        run: echo "date=$(TZ=Asia/Tokyo date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Playwright browsers
        id: cache-playwright-browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-

      - name: Install Playwright Browsers
        if: steps.cache-playwright-browsers.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Set OS Short Name
        shell: bash
        run: |
          OS_NAME="${{ matrix.os }}"
          if [[ "$OS_NAME" == "ubuntu-latest" ]]; then echo "OS_SHORT_NAME=ubuntu" >> $GITHUB_ENV;
          elif [[ "$OS_NAME" == "windows-latest" ]]; then echo "OS_SHORT_NAME=win" >> $GITHUB_ENV;
          elif [[ "$OS_NAME" == "macos-latest" ]]; then echo "OS_SHORT_NAME=macos" >> $GITHUB_ENV;
          else echo "OS_SHORT_NAME=unknown" >> $GITHUB_ENV; fi

      - name: Run Premium E2E Tests
        id: run_tests
        shell: bash
        # 最も安定した直列実行(1ワーカー)で実行。
        run: |
          npx playwright test tests/specs/premium --project=${{ matrix.browser }} --reporter=line --workers=1
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT
        env:
          TEST_RUN_SUFFIX: ${{ env.OS_SHORT_NAME }} 
          PWAPPY_TEST_BASE_URL: ${{ secrets.PWAPPY_TEST_BASE_URL }}
          PWAPPY_TEST_AUTH: ${{ secrets.PWAPPY_TEST_AUTH }}
          PWAPPY_TEST_IDENT_KEY: ${{ secrets.PWAPPY_TEST_IDENT_KEY }}
          PWAPPY_LOGIN: "1"
          TEST_GEMINI_API_KEY: ${{ secrets.TEST_GEMINI_API_KEY }}

      - name: Delete cache on failure
        if: failure()
        run: |
          echo "Test failed. Clearing all related caches for ${{ env.CACHE_KEY_PREFIX }}..."
          gh cache list --key "${{ env.CACHE_KEY_PREFIX }}-" --json key --jq '.[].key' | xargs -I {} gh cache delete {} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-premium-${{ matrix.os }}-${{ matrix.browser }}-${{ github.run_id }}
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Mark Job Failure
        if: steps.run_tests.outputs.EXIT_CODE != '0'
        run: exit 1

  # ===================================================================
  # ジョブ 4: クリーンアップ (全テスト完了後に実行)
  # ===================================================================
  cleanup:
    # NormalまたはPremiumいずれかの実行が終わった後、常に呼び出す。
    needs: [e2e-normal, e2e-premium]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers
    steps:
      - name: Checkout repository for cleanup
        uses: actions/checkout@v4

      - name: Set cache key prefix for cleanup
        run: |
          echo "CACHE_KEY_PREFIX=${{ runner.os }}-playwright-chromium-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_ENV

      - name: Setup Node.js for cleanup
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies for cleanup
        run: npm install

      - name: Get daily cache key suffix
        id: get-date
        run: echo "date=$(TZ=Asia/Tokyo date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Playwright browsers for cleanup
        id: cache-playwright-browsers-cleanup
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-

      - name: Install Playwright Browsers
        if: steps.cache-playwright-browsers-cleanup.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Run Cleanup Script
        run: npx playwright test tests/tools/a0-cleanup-all-apps.spec.ts --project=chromium
        env:
          PWAPPY_TEST_BASE_URL: ${{ secrets.PWAPPY_TEST_BASE_URL }}
          PWAPPY_TEST_AUTH: ${{ secrets.PWAPPY_TEST_AUTH }}
          PWAPPY_TEST_IDENT_KEY: ${{ secrets.PWAPPY_TEST_IDENT_KEY }}
          PWAPPY_LOGIN: "1"
          TEST_GEMINI_API_KEY: ${{ secrets.TEST_GEMINI_API_KEY }}

      - name: Check upstream job status
        # 先行するe2e-normalまたはe2e-premiumの結果を確認。
        # 実行されたジョブがいずれか一方でも失敗（failure）していたら、このジョブも失敗させる。
        if: |
          (needs.e2e-normal.result == 'failure') || 
          (needs.e2e-premium.result == 'failure')
        run: |
          echo "One or more upstream test jobs reported failure. Propagating status."
          exit 1